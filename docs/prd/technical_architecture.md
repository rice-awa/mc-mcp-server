# Minecraft Agent服务器技术架构

## 系统架构概述

Minecraft Agent服务器是一个多层架构系统，由两个主要组件组成：AIAgent(Agent-server)负责管理AI工具和处理LLM交互，以及基于WebSocket和脚本API的MC服务器负责处理游戏交互。

```
┌─────────────────┐
│  Minecraft客户端  │
└────────┬────────┘
         │ WebSocket + 脚本API
┌────────▼────────┐
│  MC服务器        │ ◄─────┐
│ (游戏交互层)      │       │
└────────┬────────┘       │
         │                │
         │                │
┌────────▼────────┐       │
│  AIAgent        │       │
│ (Agent-server)  │───────┘
└────────┬────────┘
         │ MCP
┌────────▼────────┐
│     LLM API     │
└─────────────────┘
```

## 请求路径

系统支持两种主要的请求路径：

### 1. 外部MCP客户端路径

```
┌─────────────┐    MCP    ┌─────────────┐    WebSocket    ┌─────────────┐
│ 外部MCP客户端 │─────────►│   AIAgent   │───────────────►│ Minecraft   │
└─────────────┘           │ (Agent-server)│◄───────────────┤ 客户端       │
                          └─────────────┘                └─────────────┘
```

在这种路径中：
- 外部MCP客户端向AIAgent发送请求
- AIAgent处理请求并通过WebSocket与Minecraft客户端交互
- Minecraft客户端通过WebSocket返回结果给AIAgent
- AIAgent将结果返回给外部MCP客户端

### 2. 游戏内聊天路径

```
┌─────────────┐    聊天消息    ┌─────────────┐    MCP    ┌─────────────┐
│ Minecraft   │───────────────►│   MC服务器   │─────────►│   AIAgent   │
│ 客户端       │◄───────────────┤             │◄─────────┤             │
└─────────────┘    WebSocket   └─────────────┘          └─────────────┘
                                                              │
                                                              ▼
                                                        ┌─────────────┐
                                                        │   LLM API   │
                                                        └─────────────┘
```

在这种路径中：
- 玩家在游戏内发送聊天消息
- MC服务器通过WebSocket监听这些聊天消息
- MC服务器将消息转发给AIAgent
- AIAgent处理消息并通过LLM API获取响应
- AIAgent将响应返回给MC服务器
- MC服务器通过WebSocket将响应发送回游戏内

## 核心组件

### 1. MC服务器（游戏交互层）

负责与Minecraft客户端建立和维护WebSocket连接，处理游戏内交互。

**关键功能**:
- WebSocket连接管理
- 脚本API集成
- 游戏事件监听（如聊天消息）
- 命令执行和游戏内响应

**技术实现**:
- 使用Python `websockets` 库
- 集成Minecraft脚本API
- 异步IO处理 (`asyncio`)
- JSON消息格式

### 2. AIAgent (Agent-server)

管理AI工具和处理LLM交互，实现Agent标准。

**关键功能**:
- Agent资源和工具管理
- LLM请求处理
- 上下文管理
- 工具调用执行

**技术实现**:
- MCP Python SDK
- 资源和工具装饰器
- 标准化请求/响应格式

### 3. 命令处理器

解析和处理来自Minecraft客户端的命令，根据命令类型调用相应的处理函数。

**命令类型**:
- 登录命令
- LLM聊天命令
- 上下文管理命令
- 游戏命令执行
- 脚本事件处理

**实现方式**:
- 命令解析器
- 命令处理函数映射
- 权限验证机制

### 4. LLM交互模块

负责与LLM API通信，发送用户提示并处理模型响应。

**功能**:
- 构建LLM请求
- 流式响应处理
- 思考链处理
- 错误处理和重试机制

**技术实现**:
- 自定义`GPTAPIConversation`类
- 异步流式处理
- 响应解析和格式化

### 5. 脚本API集成模块

利用Minecraft脚本API获取游戏内信息并与游戏交互。

**功能**:
- 获取玩家信息
- 获取世界状态
- 执行游戏命令
- 监听游戏事件

**技术实现**:
- Minecraft脚本API接口
- 事件订阅和处理
- 数据转换和格式化

### 6. 安全认证模块

处理用户认证和权限控制。

**功能**:
- 密钥验证
- 令牌生成和管理
- 会话管理
- 权限检查

**技术实现**:
- 自定义`auth`模块
- 令牌存储和验证机制
- 会话超时处理

## 数据流

### 1. 外部MCP客户端路径数据流

```
外部MCP客户端 -> MCP请求 -> AIAgent -> WebSocket消息 -> MC服务器 -> Minecraft客户端
Minecraft客户端 -> 游戏响应 -> MC服务器 -> WebSocket响应 -> AIAgent -> MCP响应 -> 外部MCP客户端
```

### 2. 游戏内聊天路径数据流

```
Minecraft客户端 -> 聊天消息 -> MC服务器 -> 命令解析 -> AIAgent -> LLM请求
LLM API -> LLM响应 -> AIAgent -> 响应处理 -> MC服务器 -> WebSocket消息 -> Minecraft客户端
```

## 技术栈

### 后端

- **语言**: Python 3.7+
- **WebSocket**: `websockets` 库
- **异步处理**: `asyncio`
- **LLM集成**: 自定义API客户端
- **MCP实现**: MCP Python SDK
- **游戏交互**: Minecraft脚本API

### 依赖库

- `websockets`: WebSocket服务器实现
- `asyncio`: 异步IO处理
- `uuid`: 生成唯一标识符
- `json`: JSON数据处理
- `re`: 正则表达式处理
- `mcp`: MCP Python SDK

## 部署架构

### 开发环境

```
┌─────────────────┐
│ 开发机           │
│                 │
│ ┌─────────────┐ │
│ │ MC服务器     │ │
│ └─────┬───────┘ │
│       │         │
│ ┌─────▼───────┐ │
│ │ AIAgent     │ │
│ └─────────────┘ │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   LLM API服务   │
└─────────────────┘
```

### 生产环境

```
┌─────────────────┐     ┌─────────────────┐
│ Minecraft客户端  │◄───►│   负载均衡器     │
└─────────────────┘     └────────┬────────┘
                                 │
                 ┌───────────────┴───────────────┐
                 │                               │
        ┌────────▼────────┐           ┌─────────▼─────────┐
        │  MC服务器1       │           │   MC服务器2        │
        └────────┬────────┘           └─────────┬─────────┘
                 │                               │
                 └───────────┬───────────────────┘
                             │
                    ┌────────▼────────┐
                    │    AIAgent      │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │    LLM API服务   │
                    └─────────────────┘
```

## 扩展性设计

### 1. 模块化架构

系统采用模块化设计，各组件之间通过明确的接口进行通信，便于独立开发和替换。

### 2. 插件系统

计划实现插件系统，允许开发者扩展以下功能：
- 自定义命令处理器
- 自定义LLM模型适配器
- 自定义资源提供者
- 自定义工具实现
- 自定义脚本API集成

### 3. 配置系统

支持通过配置文件自定义以下内容：
- 服务器参数（IP、端口）
- LLM模型选择和参数
- 系统提示词
- 安全设置
- 脚本API设置

## 性能考虑

### 1. 并发处理

- 使用异步IO处理多客户端连接
- 流式处理LLM响应，减少等待时间
- 消息队列处理峰值负载

### 2. 资源优化

- 连接池管理
- 缓存常用响应
- 限制单客户端请求频率

### 3. 错误恢复

- 自动重连机制
- 请求重试策略
- 优雅降级处理

## 监控与日志

### 1. 日志系统

- 请求/响应日志
- 错误日志
- 性能指标日志

### 2. 监控指标

- 活跃连接数
- 请求处理时间
- LLM API调用统计
- 错误率统计

## 安全设计

### 1. 通信安全

- WebSocket安全连接(WSS)
- 消息加密
- 防重放攻击

### 2. 认证与授权

- 多因素认证
- 基于角色的访问控制
- 令牌过期机制

### 3. 输入验证

- 命令输入验证
- LLM提示注入防护
- 命令执行限制

## 未来技术路线

### 近期计划

1. 完善脚本API集成
2. 增强安全认证系统
3. 优化性能和稳定性

### 中期计划

1. 实现插件系统
2. 添加Web管理界面
3. 扩展资源和工具库

### 长期计划

1. 分布式部署支持
2. 多游戏版本兼容
3. 高级AI功能集成 